from flask import Flask, render_template, request, jsonify
from anthropic import Anthropic
import os

app = Flask(__name__)

# Skills 내용 (PDF 처리 예제)
SKILL_CONTENT = """당신은 PDF 처리 전문가입니다.

# PDF 처리 Skill

## 이 skill을 사용하는 경우
사용자가 PDF 문서 작업을 요청할 때 사용합니다.

## 주요 기능
1. **텍스트 추출**: pdfplumber 라이브러리 사용
2. **테이블 추출**: 표 구조를 유지하며 데이터 추출
3. **PDF 폼 작성**: PyPDF2로 폼 필드 자동 채우기
4. **문서 병합**: 여러 PDF를 하나로 결합

## 단계별 처리 방법

### 텍스트 추출
```python
import pdfplumber

with pdfplumber.open('document.pdf') as pdf:
    for page in pdf.pages:
        text = page.extract_text()
        print(text)
```

### 테이블 추출
```python
with pdfplumber.open('document.pdf') as pdf:
    for page in pdf.pages:
        tables = page.extract_tables()
        for table in tables:
            # CSV로 변환 가능
            df = pd.DataFrame(table[1:], columns=table[0])
```

### PDF 병합
```python
from PyPDF2 import PdfMerger

merger = PdfMerger()
for pdf in ['file1.pdf', 'file2.pdf', 'file3.pdf']:
    merger.append(pdf)
merger.write('merged.pdf')
```

## 주의사항
- 스캔된 PDF는 OCR 필요 (pytesseract)
- 암호화된 PDF는 먼저 암호 해제
- 대용량 파일은 페이지 단위로 처리"""

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/compare', methods=['POST'])
def compare():
    try:
        data = request.json
        prompt = data.get('prompt')
        
        # API 키 확인
        api_key = os.environ.get('ANTHROPIC_API_KEY')
        if not api_key:
            return jsonify({'error': 'API 키가 설정되지 않았습니다. Replit Secrets에 ANTHROPIC_API_KEY를 추가하세요.'}), 400
        
        client = Anthropic(api_key=api_key)
        
        # 1. Skills 없이 요청
        response_without = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1000,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        # 2. Skills 포함 요청
        response_with = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1000,
            system=SKILL_CONTENT,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        return jsonify({
            'without_skills': response_without.content[0].text,
            'with_skills': response_with.content[0].text,
            'tokens_without': response_without.usage.input_tokens + response_without.usage.output_tokens,
            'tokens_with': response_with.usage.input_tokens + response_with.usage.output_tokens
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)